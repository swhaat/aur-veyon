name: Check for Updates and Build

on:
  schedule:
    # Run every 3 days at 00:00 UTC
    - cron: '0 0 */3 * *'
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      needs_update: ${{ steps.compare.outputs.needs_update }}
      latest_version: ${{ steps.get_latest.outputs.latest_version }}
      latest_tag: ${{ steps.get_latest.outputs.latest_tag }}
      current_version: ${{ steps.get_current.outputs.current_version }}
      commit_hash: ${{ steps.get_commit.outputs.commit_hash }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest Veyon release
        id: get_latest
        run: |
          LATEST_RELEASE=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/veyon/veyon/releases/latest)
          LATEST_TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
          LATEST_VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
          echo "Latest version: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Get current PKGBUILD version
        id: get_current
        run: |
          CURRENT_VERSION=$(grep '^pkgver=' PKGBUILD | cut -d= -f2)
          echo "Current version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Compare versions
        id: compare
        run: |
          CURRENT="${{ steps.get_current.outputs.current_version }}"
          LATEST="${{ steps.get_latest.outputs.latest_version }}"
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "New version available: $LATEST (current: $CURRENT)"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Already up to date: $CURRENT"
          fi

      - name: Get commit hash for new version
        if: steps.compare.outputs.needs_update == 'true'
        id: get_commit
        run: |
          TAG="${{ steps.get_latest.outputs.latest_tag }}"
          REF=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/veyon/veyon/git/ref/tags/$TAG")
          SHA=$(echo "$REF" | jq -r '.object.sha')
          TYPE=$(echo "$REF" | jq -r '.object.type')
          # Dereference annotated tags to get the underlying commit
          if [ "$TYPE" = "tag" ]; then
            SHA=$(curl -s \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/veyon/veyon/git/tags/$SHA" \
              | jq -r '.object.sha')
          fi
          echo "Commit hash: $SHA"
          echo "commit_hash=$SHA" >> $GITHUB_OUTPUT

  build-and-create-pr:
    needs: check-version
    if: needs.check-version.outputs.needs_update == 'true'
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged
    env:
      LATEST_VERSION: ${{ needs.check-version.outputs.latest_version }}
      LATEST_TAG: ${{ needs.check-version.outputs.latest_tag }}
      CURRENT_VERSION: ${{ needs.check-version.outputs.current_version }}
      COMMIT_HASH: ${{ needs.check-version.outputs.commit_hash }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Initialize keyring and update system
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm

      - name: Install required tools
        run: |
          pacman -S --noconfirm devtools git github-cli namcap

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if update branch already exists
        id: check_branch
        run: |
          BRANCH="update-veyon-${LATEST_VERSION}"
          if git ls-remote --exit-code --heads origin "$BRANCH" > /dev/null 2>&1; then
            echo "Branch $BRANCH already exists — skipping"
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            echo "branch_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update PKGBUILD for new version
        if: steps.check_branch.outputs.branch_exists == 'false'
        run: |
          sed -i "s/^pkgver=.*/pkgver=${LATEST_VERSION}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          sed -i "s|^_commit=.*|_commit=${COMMIT_HASH}  # tags/v${LATEST_VERSION}|" PKGBUILD
          echo "Updated PKGBUILD:"
          grep -E '^(pkgver|pkgrel|_commit)=' PKGBUILD

      - name: Create build user
        if: steps.check_branch.outputs.branch_exists == 'false'
        run: |
          useradd -m -G wheel builder
          echo '%wheel ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          chown -R builder:builder .

      - name: Create clean chroot
        if: steps.check_branch.outputs.branch_exists == 'false'
        run: |
          mkdir -p /var/lib/archbuild/extra-x86_64
          mkarchroot /var/lib/archbuild/extra-x86_64/root base-devel

      - name: Build package in clean chroot
        if: steps.check_branch.outputs.branch_exists == 'false'
        run: |
          sudo -u builder makechrootpkg -c -r /var/lib/archbuild/extra-x86_64

      - name: Check package with namcap
        if: steps.check_branch.outputs.branch_exists == 'false'
        run: |
          namcap PKGBUILD
          namcap *.pkg.tar.zst || true

      - name: Generate updated .SRCINFO
        if: steps.check_branch.outputs.branch_exists == 'false'
        run: |
          sudo -u builder makepkg --printsrcinfo > .SRCINFO

      - name: Upload built package as artifact
        if: steps.check_branch.outputs.branch_exists == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: veyon-${{ env.LATEST_VERSION }}
          path: |
            *.pkg.tar.zst
            .SRCINFO
          retention-days: 30

      - name: Commit, push branch, and open PR
        if: steps.check_branch.outputs.branch_exists == 'false'
        run: |
          BRANCH="update-veyon-${LATEST_VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Use GitHub token for authentication
          gh auth setup-git

          git checkout -b "$BRANCH"
          git add PKGBUILD .SRCINFO
          git commit -m "Update veyon to ${LATEST_VERSION}"
          git push -u origin "$BRANCH"

          gh pr create \
            --title "Update veyon to ${LATEST_VERSION}" \
            --base main \
            --head "$BRANCH" \
            --body "Automated update from \`${CURRENT_VERSION}\` to \`${LATEST_VERSION}\`.

## Changes
- Version: \`${CURRENT_VERSION}\` → \`${LATEST_VERSION}\`
- Commit: \`${COMMIT_HASH}\`
- Release notes: https://github.com/veyon/veyon/releases/tag/${LATEST_TAG}

## Build
Package was successfully built in a clean Arch Linux chroot before this PR was created.

## Checklist
- [ ] Review PKGBUILD changes
- [ ] Verify package installs and runs correctly
- [ ] Merge and deploy to AUR

*This PR was automatically created by the update-checker workflow.*"
